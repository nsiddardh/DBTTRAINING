











-- Generated by dbtvault.



WITH source_data AS (

    SELECT *

    FROM TESTDBT.DBT_SNAMBURI.raw_source
),

derived_columns AS (

    SELECT

    'STG_BOOKING' AS SOURCE,
    BOOKING_DATE AS EFFECTIVE_FROM

    FROM source_data
),

hashed_columns AS (

    SELECT

    SOURCE,
    EFFECTIVE_FROM,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS VARCHAR))), ''))) AS BINARY(16)) AS CUSTOMER_PK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST('9999-12-31' AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMER_DOB AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMER_NAME AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS CUST_CUSTOMER_HASHDIFF,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(NATIONALITY AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(PHONE AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS CUSTOMER_HASHDIFF

    FROM derived_columns
),

ranked_columns AS (

    SELECT *,

    RANK() OVER (PARTITION BY CUSTOMER_ID ORDER BY BOOKING_DATE) AS DBTVAULT_RANK

    FROM hashed_columns
),

columns_to_select AS (

    SELECT

    SOURCE,
    EFFECTIVE_FROM,
    CUSTOMER_PK,
    CUST_CUSTOMER_HASHDIFF,
    CUSTOMER_HASHDIFF,
    DBTVAULT_RANK

    FROM ranked_columns
)

SELECT * FROM columns_to_select